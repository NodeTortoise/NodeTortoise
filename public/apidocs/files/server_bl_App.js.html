<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>server\bl\App.js - API de NodeTortoise</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="API de NodeTortoise" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/App.html">App</a></li>
                                <li><a href="../classes/Controller.html">Controller</a></li>
                                <li><a href="../classes/Controller.model.html">Controller.model</a></li>
                                <li><a href="../classes/Controller.session.html">Controller.session</a></li>
                                <li><a href="../classes/Model.html">Model</a></li>
                                <li><a href="../classes/Session.html">Session</a></li>
                                <li><a href="../classes/SessionController.html">SessionController</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Model.html">Model</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: server\bl\App.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/* global __dirname, module, ROOT_DIR, DEBUG_MODE, MASTER_PASSWORD, TEMP_PATH, LIBS_PATH */

/**
 * Controlador principal de la aplicación en el lado del servidor. Se encarga de 
 * establecer los parámetros de configuración, configurando el framework Express, 
 * las rutas y el motor de plantillas (templates).
 * @class App
 * @constructor
 */
App = function () {

    var app;

    /**
     * Inicializa el proceso de definición de los parámetros de configuración 
     * de la aplicación.
     * @method init
     * @private
     * @param {http.Server} server
     */
    var init = function (server) {
        var Sockets = App.require(&#x27;/da/Sockets&#x27;);
        var SessionController = App.require(&#x27;/bl/SessionController&#x27;);
        Sockets.init(server);
        SessionController.getInstance().init();
    };

    /**
     * Establece los parámetros de configuración de Express y el motor de 
     * plantillas Swig y otros (logger, cookieParser, etc).
     * @method setupConfig
     * @private
     */
    var setupConfig = function () {
        var favicon = require(&#x27;serve-favicon&#x27;);
        var logger = require(&#x27;morgan&#x27;);
        var cookieParser = require(&#x27;cookie-parser&#x27;);
        var bodyParser = require(&#x27;body-parser&#x27;);
        var compression = require(&#x27;compression&#x27;);
        var express = require(&#x27;express&#x27;);
        app = express();
        //--&gt; View engine setup
        var swig = require(&#x27;swig&#x27;);
        app.set(&#x27;views&#x27;, App.getPath(&#x27;/views&#x27;));
        app.engine(&#x27;html&#x27;, swig.renderFile);
        app.set(&#x27;view engine&#x27;, &#x27;html&#x27;);
        app.set(&#x27;view cache&#x27;, false);
        swig.setDefaults({cache: false});
        swig.setDefaults({cache: false, varControls: [&#x27;{@&#x27;, &#x27;@}&#x27;]});
        // uncomment after placing your favicon in /public
        //app.use(favicon(path.join(__dirname, &#x27;public&#x27;, &#x27;favicon.ico&#x27;)));
        //--&gt; File upload setup
        var multer = require(&#x27;multer&#x27;);
        var Controller = App.require(&#x27;/bl/Controller&#x27;);
        app.use(multer({
            dest: App.getPath(TEMP_PATH),
            onFileUploadComplete: Controller.model.onUpload
        }));
        app.use(logger(&#x27;dev&#x27;));
        app.use(bodyParser.json());
        app.use(bodyParser.urlencoded({extended: false}));
        app.use(cookieParser());
        app.use(compression());
        //app.use(express.static(App.getRootPath(&#x27;public&#x27;)));
        //app.use(&#x27;/libs&#x27;, express.static(App.getRootPath(LIBS_PATH)));
    };

    /**
     * Establece los parámetros de configuración de las rutas accesibles por 
     * medio del protocolo HTTP.
     * @method setupRoutes
     * @private
     */
    var setupRoutes = function () {
        //--&gt; Static routes
        var express = require(&#x27;express&#x27;);
        app.use(express.static(App.getRootPath(&#x27;public&#x27;)));
        app.use(&#x27;/libs&#x27;, express.static(App.getRootPath(LIBS_PATH)));
        //--&gt; App routes
        var index = App.require(&#x27;/routes/index&#x27;);
        var model = App.require(&#x27;/routes/model&#x27;);
        var session = App.require(&#x27;/routes/session&#x27;);
        var info = App.require(&#x27;/routes/info&#x27;);
        app.use(&#x27;/&#x27;, index);
        app.use(&#x27;/model&#x27;, model);
        app.use(&#x27;/session&#x27;, session);
        app.use(&#x27;/info&#x27;, info);
        //--&gt; Catch 404 and forward to error handler
        app.use(function (req, res, next) {
            var err = new Error(&#x27;Not Found&#x27;);
            err.status = 404;
            next(err);
        });
        //--&gt; Development error handler
        if (app.get(&#x27;env&#x27;) === &#x27;development&#x27;) {
            app.use(function (err, req, res, next) {
                res.status(err.status || 500);
                res.render(&#x27;error&#x27;, {message: err.message, error: err});
            });
        }
        //--&gt; Production error handler
        app.use(function (err, req, res, next) {
            res.status(err.status || 500);
            res.render(&#x27;error&#x27;, {message: err.message, error: {}});
        });
    };

    /**
     * Constructor de la clase.
     * @method __construct
     * @private
     */
    var __construct = function () {
        App.include(&#x27;/commons/Helper&#x27;);
        setupConfig();
        setupRoutes();
        app.init_ = init;
    };

    /**
     * Returna la instancia de Express utilizada.
     * @method getExpress
     * @return {express} app Instancia de express
     */
    this.getExpress = function () {
        return app;
    };

    __construct();

};

/**
 * Retorn la ruta desde el directorio raíz de la aplicación basado en la ruta 
 * recibida.
 * @method getRootPath
 * @static
 * @param {String} filePath Ruta relativa del archivo
 * @return {String} La ruta a la raíz de la aplicación
 */
App.getRootPath = function (filePath) {
    var path = require(&#x27;path&#x27;);
    return path.join(ROOT_DIR, filePath);
};

/**
 * Retorn la ruta desde el directorio de los archivos del servidor de la 
 * aplicación basado en la ruta recibida.
 * @method getPath
 * @static
 * @param {String} filePath Ruta relativa del archivo
 * @return {String} La ruta al directorio de los archivos del servidor de la aplicación
 */
App.getPath = function (filePath) {
    var path = require(&#x27;path&#x27;);
    return path.join(ROOT_DIR, &#x27;/server&#x27;, filePath);
};

/**
 * Incluye el cídigo de un archivo dentro de la aplicación.
 * @method include
 * @static
 * @param {String} file Ruta relativa del archivo
 */
App.include = function (filePath) {
    var fs = require(&#x27;fs&#x27;);
    eval(fs.readFileSync(App.getRootPath(filePath + &#x27;.js&#x27;)) + &#x27;&#x27;);
};

/**
 * Realiza el require de cualquiera de los módulos ubicados dentro del directorio
 * de los archivos del servidor de la aplicación.
 * @method require
 * @static
 * @param {String} module Ruta relativa del modulo
 * @return {mixed} El &lt;i&gt;requite&lt;/i&gt; del modulo
 */
App.require = function (module) {
    return (require(App.getPath(module)));
};

/**
 * Imprime en consola un mensaje de depuración, personalizado para la aplicación.
 * La impresión del mensaje es condicionada por el valor de la variable global  
 * &lt;i&gt;DEBUG_MODE&lt;i&gt; en el archivo de configuración de la aplicación y el valor del
 * parámetro &lt;i&gt;mode&lt;/i&gt; recibido
 * @method debug
 * @static
 * @param {String} message El mensaje a imprimir en consola
 * @param {String} user El usuario que está enviando el mensaje (cuando se está en modo simulación)
 * @param {String} session La sesion del usuario que está enviando el mensaje (cuando se está en modo simulación)
 * @param {String} mode El modo de debug a aplicar al mensaje
 */
App.debug = function (message, user, session, mode) {
    if (!mode) {
        mode = 1;
    }
    if (mode &lt;= DEBUG_MODE) {
        if (session) {
            console.log(&#x27;DEBUG =&gt;&#x27;, session, &#x27;=&gt;&#x27;, user, &#x27;=&gt;&#x27;, message);
        } else {
            console.log(&#x27;DEBUG =&gt;&#x27;, user, &#x27;=&gt;&#x27;, message);
        }
    }
};

/**
 * Retorna la instancia del objeto Express utilizado
 * @method getInstance
 * @static
 * @return {express} Instancia de express
 */
App.getInstance = function () {
    if (typeof App._instance_ !== &#x27;object&#x27;) {
        App._instance_ = new App();
    }
    return App._instance_.getExpress();
};

/**
 * Determina si el usuario es master comparando con la contraseña enviada por 
 * parámetro con la contraseña del usuario maestro.
 * @method isUserMaster
 * @static
 * @param {String} userPassword La contraseña del usuario
 * @return {Boolean} El resultado de la comparación de las contraseñas
 */
App.isUserMaster = function (userPassword) {
    return (userPassword === MASTER_PASSWORD);
};

module.exports = App;
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
